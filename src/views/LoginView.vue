<template>
  <main>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="2400"
      height="1600"
      viewBox="0 0 2400 1600"
    >
      <g
        id="module-01"
        fill="none"
        fill-rule="evenodd"
        class="path path-01"
        stroke-linejoin="round"
      >
        <g id="C22">
          <path d="M0 239h24l32 32v124l12 12v4" />
          <path d="M0 247h20l29 29v124l3 3v8" />
          <path d="M0 271h7l16 16v121l-11.04536 11.04536L12 487v9l-13 13" />
          <path d="M-1 521l21-21v-76l12-12V284l-21-21H0" />
          <path d="M-1 556v-24l29-29v-75l12-12V279l-24-24H0" />
        </g>
        <g id="C21">
          <path
            d="M300 476h60l16.03122-16.03122h94.968785M0 156h76l44 44v116l36 36h20l32 32v16l-12 12v40l32 32h24m48 0h91l4-4h69l4-4h8l44 44h36"
          />
          <path
            d="M300 468h56l16-16h4l4-4M0 132h88l56 56v108l80 80v32l-12 12v24l24 24h16"
          />
          <path d="M300 460h52l32-32m-160 4v12l16 16h12" />
          <path
            d="M300 452h47l29-29v-3l9-9M136 127v9l16 16v140l80 80v36l4 4v32l8 8h8"
          />
          <path
            d="M300 444h16l4-4h16m12 272h-20l-24-24V524l-8-8v-28m-52-92v44l4 4h4"
          />
          <path
            d="M264 440v-60l-96-96V144l-8-8v-9m100 477l-.015615-47.984365-12.015605-12.015604v-15.96881L264 512v-24"
          />
          <path d="M256 440v-56l-96-96V148l-12-12v-21m91 406l17-17v-16" />
          <path
            d="M272 440v-64l-96-96V140l-4-4v-20m87 416v-3l13-13v-28m0 60v-20l8-8v-32m8-48v-88l16-16v-9m44 393h-25l-27-27V529l-8-8v-33"
          />
          <path
            d="M296 440v-84l20-20v-20M0 148l79.989585-.010416L128 196v116l16 16h20l52 52v24l-12 12.285714v32.285715L231.42857 476H252"
          />
        </g>
        <g id="C14">
          <path d="M580 196h16l12 12v16l24 24h92l5-5h7" />
          <path
            d="M580 188h20l16 16v16l20 20h84.005952l7.997025-7.997024H788l13.001488-13.001488L802 218v-47M688.05579 370.99653h-9.052317L676 367.99306h-43.993057L604.013886 340v-72.986114L568 231v-15m-260.000025-48.033296h20.96673L344 183h100l29 29h59"
          />
          <path d="M580 212h8l4 4v16l28 28v36l56 56h28l4-4h8" />
          <path
            d="M580 204h12l8 8v15l28 28v37.01351l51.993245 51.993246h20.031395l9.044776-9.044776h18.930622M556 360v-4l17-17v-19l-17-17v-36l-20-20v-31m52 136v-76l-36-36v-24m-21-20h-51l-28-28V0m92 168v-20l36-36V0"
          />
          <path
            d="M532 204h-55l-33-33V0m92 167v-23l36-36V0m.003967 360v-8.99603L580 343.007935V280l-36-36v-28"
          />
          <path d="M603.996576 360v-7.996575L596 344.00685V271l-36-36v-19" />
          <path
            d="M728.005435 359H636l-24-24v-71l-36-36v-12m-43.98983-27.977576h-46.99242L460 163.004674V0m92 168v-16l36-36V0"
          />
          <path d="M532 180h-43l-21-21V0m92 168v-12l36-36V0" />
          <path d="M532 172h-39l-17-17V0m92 168v-8l36-36V0" />
          <path d="M576 168v-4l36-36V0" />
        </g>
      </g>
      <g
        id="module-02"
        fill="none"
        fill-rule="evenodd"
        class="path path-02"
        stroke-linejoin="round"
      >
        <g id="C12">
          <path d="M1028 92h32l32-32V0" />
          <path d="M1028 84h28l28-28V0" />
          <path d="M1028 76h24l24-24V0" />
          <path d="M1028 68h20l20-20V0" />
          <path
            d="M1028 60h16l16-16V0m-68 56V0m-8 56V0m16 56V0m8 56V0m8 56V0m8 56V0m4 100h20l8.01561 8.01561v15.991728M1072 284h-8l-4 4h-52l-16-16V104"
          />
          <path d="M1080 439v-67l-96-96V104" />
          <path d="M1100 272h-36l-8 8h-44l-12-12V104" />
          <path d="M1044 268h-32l-4-4V104" />
          <path
            d="M1020.03113 252.00006v-7.96893L1016 240V104m8 4v-4 80l8 8h8"
          />
        </g>
      </g>
      <g
        id="module-04"
        fill="none"
        fill-rule="evenodd"
        class="path path-04"
        stroke-linejoin="round"
      >
        <g id="C19">
          <path
            d="M1900 476h60l16.03122-16.03122h94.968785M1532 167h12l11-11h121l44 44v116l36 36h20l32 32v16l-12 12v40l32 32h24m48 0h91l4-4h69l4-4h8l44 44h36"
          />
          <path
            d="M1900 468h56l16-16h4l4-4m-448-329h4l13 13h139l56 56v108l80 80v32l-12 12v24l24 24h16"
          />
          <path d="M1900 460h52l32-32m-160 4v12l16 16h12" />
          <path
            d="M1900 452h47l29-29v-3l9-9m-249-284v9l16 16v140l80 80v36l4 4v32l8 8h8"
          />
          <path
            d="M1900 444h16l4-4h16m12 272h-20l-24-24V524l-8-8v-28m-52-92v44l4 4h4"
          />
          <path
            d="M1864 440v-60l-96-96V144l-8-8v-9m100 477l-.015615-47.984365-12.015605-12.015604v-15.96881L1864 512v-24"
          />
          <path d="M1856 440v-56l-96-96V148l-12-12v-21m91 406l17-17v-16" />
          <path
            d="M1872 440v-64l-96-96V140l-4-4v-20m87 416v-3l13-13v-28m0 60v-20l8-8v-32m8-48v-88l16-16v-9m44 393h-25l-27-27V529l-8-8v-33"
          />
          <path
            d="M1896 440v-84l20-20v-20m-384-165h17l3-3h48l79.989584-.010416L1728 196v116l16 16h20l52 52v24l-12 12.285714v32.285715L1831.42857 476H1852"
          />
        </g>
      </g>
    </svg>

    <header>
      <div class="flex justify-between h-screen">
        <div class="w-1/3 p-8 flex flex-col justify-center">
          <div class="mt-auto">
            <h1 class="text-8xl font-bold">
              Sol Vault<span class="blink-animation">|</span>
            </h1>
            <h3 class="text-xl">Password Manager based on Solana Blockchain</h3>
          </div>
          <p class="self-end mt-auto">
            Disclaimer: This is only intended for educational purposes. Although
            all the data is encrypted with your password - It's still highly
            discouraged to use this for storing sensitive data.
          </p>
        </div>
        <div
          class="w-1/3 bg-primary bg-shadow-l flex flex-col justify-center items-center"
        >
          <h5 class="mb-4" v-if="!publicKey">Login with your wallet</h5>
          <wallet-multi-button dark v-if="!publicKey"></wallet-multi-button>
          <label class="mt-8 mb-2" for="password" v-if="publicKey">{{
            store.hash ? "Enter your Password" : "Set a password"
          }}</label>

          <div class="flex items-center justify-center" v-if="publicKey">
            <input
              type="password"
              id="password"
              class="w-64 h-12 px-4 text-lg text-white placeholder-white rounded-l-lg focus:outline-none"
              style="background: #8bc6ec"
              placeholder="Password"
              v-model="password"
            />

            <button
              class="h-12 w-8 rounded-r-lg"
              style="background: #8bc6ec"
              @click="login"
            >
              <mdicon name="arrow-right" />
            </button>
          </div>
        </div>
      </div>
    </header>
  </main>
</template>

<script setup lang="ts">
import { Config } from "@/services/Config";
import { usePasswordsStore } from "@/stores/passwords";
import {
  Connection,
  PublicKey,
  SystemProgram,
  Transaction,
  TransactionInstruction,
} from "@solana/web3.js";
import { useWallet, WalletMultiButton } from "solana-wallets-vue";
import { ref, watch } from "vue";
import { useRouter } from "vue-router";

const { publicKey, sendTransaction } = useWallet();
const router = useRouter();
const store = usePasswordsStore();

const programId = new PublicKey("7p9vFKTNp4DSnJSY4hMsZL3ij8uKT7vwYruprrutcRwE");
const connection = new Connection("http://localhost:8899", "confirmed");

const password = ref("");

// Redirect to dashboard if logged in
watch(publicKey, (pubkey) => pubkey && store.encryptionKey && router.push("/"));
watch(publicKey, (pubkey) => pubkey && load());

const load = async () => {
  await store.fetchConfig();
};

const login = () => {
  if (store.hash && Config.decrypt(store.hash, password.value)) {
    store.setEncryptionKey(password.value);
    router.push("/");
  } else if (store.hash) alert("Wrong password"); // Add toast
  else setPassword();
};

const setPassword = async () => {
  // -> Set encryption hash on solana
  const [pda] = await PublicKey.findProgramAddress(
    // eslint-disable-next-line no-undef
    [publicKey.value!.toBuffer(), Buffer.from("config")],
    programId
  );

  const hash = Config.encrypt("VALID", password.value);

  const config = new Config(hash);

  const buffer = config.serialize();

  const tx = new Transaction().add(
    new TransactionInstruction({
      programId,
      keys: [
        {
          pubkey: publicKey.value!,
          isSigner: true,
          isWritable: false,
        },
        {
          pubkey: pda,
          isSigner: false,
          isWritable: true,
        },
        {
          pubkey: SystemProgram.programId,
          isSigner: false,
          isWritable: false,
        },
      ],
      data: buffer,
    })
  );

  try {
    const sig = await sendTransaction(tx, connection);

    store.setEncryptionKey(password.value);

    router.push("/");

    console.log(
      `Explorer: https://explorer.solana.com/tx/${sig}?cluster=custom&customUrl=http%3A%2F%2Flocalhost%3A8899`
    );
  } catch (e) {
    console.log({ TX_ERROR: e });
  }
};
</script>

<style scoped>
@-webkit-keyframes draw {
  to {
    stroke-dashoffset: 0;
  }
}
@keyframes draw {
  to {
    stroke-dashoffset: 0;
  }
}

svg {
  position: absolute;
  top: 0;
  left: 0;
  width: auto;
  height: 100vh;
  z-index: -1;
}

.path {
  animation: draw 10s linear infinite;
  stroke-dasharray: 100, 10, 200, 10;
  stroke-dashoffset: 1000;
  stroke-width: 1px;
  stroke: #b2c6d7;
  fill: none;
}
.path-01 {
  -webkit-animation-delay: 0s;
  animation-delay: 0s;
}
.path-02 {
  -webkit-animation-delay: 0;
  animation-delay: 0;
}
.path-03 {
  -webkit-animation-delay: 0;
  animation-delay: 1s;
}
.path-04 {
  -webkit-animation-delay: 0;
  animation-delay: 0;
}
</style>
